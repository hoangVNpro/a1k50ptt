<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A1K50 Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #000;
            margin: 0;
            overflow-x: hidden;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: white;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        
        .glass-panel {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .text-glow { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .hidden { display: none !important; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "firebase/": "https://esm.sh/firebase@^12.8.0/",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body>

    <!-- BACKGROUND -->
    <div class="fixed inset-0 w-full h-full z-0 overflow-hidden bg-black pointer-events-none">
        <video id="bg-video" autoplay muted loop playsinline class="absolute top-0 left-0 w-full h-full object-cover transition-opacity duration-1000 opacity-0">
            <source src="https://res.cloudinary.com/dbyap7mw2/video/upload/v1765208146/background_efe441534ad5-_1__xr2aom.webm" type="video/mp4" />
        </video>
        <div class="absolute inset-0 bg-black/40 backdrop-blur-[1px]"></div>
        <div id="stars-container" class="absolute inset-0 w-full h-full"></div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="relative z-10 container mx-auto px-4 py-8">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-12 gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 md:w-16 md:h-16 rounded-full overflow-hidden border-2 border-white/30 shadow-[0_0_20px_rgba(255,255,255,0.3)] floating">
                    <img src="https://files.catbox.moe/cwhx9o.ico" alt="Logo" class="w-full h-full object-cover" />
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-purple-200 to-white text-glow">
                        A1K50
                    </h1>
                    <p class="text-xs md:text-sm text-gray-400 tracking-widest">UY T√çN - CH·∫§T L∆Ø·ª¢NG</p>
                </div>
            </div>

            <button id="btn-toggle-mode" class="w-full md:w-auto px-6 py-2 rounded-full border border-white/20 text-sm font-bold transition-all bg-black/50 text-white hover:bg-white/10">
                üëë Qu·∫£n Tr·ªã
            </button>
        </header>

        <!-- LOADING SPINNER -->
        <div id="loading-view" class="col-span-full text-center py-20">
            <div class="floating text-6xl mb-4">üåü</div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu v≈© tr·ª•...</p>
        </div>

        <!-- CUSTOMER VIEW (PRODUCT LIST) -->
        <div id="customer-view" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 animate-fade-in">
            <!-- Product Cards injected by JS -->
        </div>

        <!-- ADMIN VIEW -->
        <div id="admin-view" class="hidden space-y-8 animate-fade-in">
            
            <!-- ADD PRODUCT FORM -->
            <div class="glass-panel rounded-3xl p-6 md:p-8 max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-green-400"></i> Th√™m S·∫£n Ph·∫©m M·ªõi
                </h2>
                <form id="add-product-form" class="space-y-4">
                    <input type="text" name="name" placeholder="T√™n s·∫£n ph·∫©m" required class="w-full bg-white/5 border border-white/10 rounded-xl p-4 focus:border-purple-500 outline-none transition-colors text-white" />
                    <div class="flex flex-col md:flex-row gap-4">
                        <input type="number" name="price" placeholder="Gi√° (VNƒê)" required class="flex-1 bg-white/5 border border-white/10 rounded-xl p-4 focus:border-purple-500 outline-none transition-colors text-white" />
                        <input type="file" id="product-image-input" accept="image/*" required class="flex-1 bg-white/5 border border-white/10 rounded-xl p-3 file:mr-4 file:py-1 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 text-gray-300" />
                    </div>
                    <textarea name="description" placeholder="M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m..." class="w-full bg-white/5 border border-white/10 rounded-xl p-4 focus:border-purple-500 outline-none transition-colors h-32 resize-none text-white"></textarea>
                    <button type="submit" id="btn-submit-product" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 py-4 rounded-xl font-bold text-lg hover:shadow-[0_0_20px_rgba(16,185,129,0.4)] transition-all disabled:opacity-50 text-white">
                        ƒêƒÇNG B√ÅN NGAY
                    </button>
                </form>
            </div>

            <!-- ORDERS TABLE -->
            <div class="glass-panel rounded-3xl p-6 md:p-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-list-ul text-yellow-400"></i> Qu·∫£n L√Ω ƒê∆°n H√†ng
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse whitespace-nowrap">
                        <thead>
                            <tr class="text-gray-400 border-b border-white/10 text-sm uppercase">
                                <th class="p-4">Th·ªùi gian</th>
                                <th class="p-4">Kh√°ch h√†ng</th>
                                <th class="p-4">S·∫£n ph·∫©m</th>
                                <th class="p-4">SL</th>
                                <th class="p-4">T·ªïng ti·ªÅn</th>
                                <th class="p-4">Tr·∫°ng th√°i</th>
                                <th class="p-4 text-center">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <!-- Orders injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- PRODUCT DETAIL MODAL -->
    <div id="product-modal" class="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="closeAllModals()"></div>
        <div class="relative w-full max-w-4xl bg-gray-900/95 border-t md:border border-white/20 rounded-t-3xl md:rounded-3xl overflow-hidden flex flex-col md:flex-row shadow-2xl max-h-[90vh] md:max-h-[95vh]">
            <button onclick="closeAllModals()" class="absolute top-4 right-4 z-10 w-10 h-10 bg-black/40 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-white/20 transition-colors border border-white/10">‚úï</button>
            
            <div class="w-full md:w-3/5 h-[40vh] md:h-auto bg-black relative flex items-center justify-center">
                <img id="modal-img" src="" alt="" class="max-w-full max-h-full object-contain" />
            </div>

            <div class="w-full md:w-2/5 p-6 md:p-8 flex flex-col text-white overflow-y-auto">
                <h2 id="modal-title" class="text-2xl md:text-3xl font-black mb-2 text-glow leading-tight"></h2>
                <p id="modal-price" class="text-xl md:text-2xl font-bold text-green-400 mb-4"></p>
                
                <div class="flex items-center gap-3 mb-6 bg-white/5 p-3 rounded-xl border border-white/5 shrink-0">
                    <div id="modal-stars" class="flex gap-1 text-2xl text-yellow-400"></div>
                    <div class="text-sm">
                        <span id="modal-rating-avg" class="block font-bold text-white text-lg leading-none"></span>
                        <span id="modal-rating-count" class="text-xs text-gray-400"></span>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto pr-2 mb-6 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent min-h-[100px]">
                    <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-2">Th√¥ng tin s·∫£n ph·∫©m</h3>
                    <p id="modal-desc" class="text-gray-200 leading-relaxed text-sm whitespace-pre-wrap"></p>
                </div>

                <div class="mt-auto pb-4">
                    <button onclick="openOrderModal()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2 group">
                        <span class="group-hover:animate-bounce">üõí</span> ƒê·∫∂T H√ÄNG NGAY
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDER FORM MODAL -->
    <div id="order-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeOrderModal()"></div>
        <div class="relative w-full max-w-md bg-gray-900 border border-white/20 rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-600">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">X√°c nh·∫≠n ƒë∆°n h√†ng</h3>
                <button onclick="closeOrderModal()" class="text-gray-400 hover:text-white w-8 h-8 flex items-center justify-center bg-white/5 rounded-full"><i class="fas fa-times"></i></button>
            </div>

            <div class="flex items-start gap-4 mb-6 p-4 bg-white/5 rounded-xl border border-white/10">
                <img id="order-img" src="" class="w-20 h-20 object-cover rounded-lg shrink-0" />
                <div class="flex-1 min-w-0">
                    <p id="order-name" class="font-bold text-white text-lg mb-1 truncate"></p>
                    <p id="order-unit-price" class="text-gray-400 text-sm"></p>
                </div>
            </div>

            <form id="order-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">T√™n ng∆∞·ªùi nh·∫≠n</label>
                        <input type="text" name="customerName" required class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors" placeholder="H·ªç v√† t√™n" />
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" name="phone" required class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors" placeholder="09..." />
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">ƒê·ªãa ch·ªâ giao h√†ng</label>
                    <textarea name="address" required rows="2" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-purple-500 transition-colors resize-none" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£..."></textarea>
                </div>

                <div class="p-4 bg-purple-900/20 border border-purple-500/30 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <label class="font-bold text-white">S·ªë l∆∞·ª£ng:</label>
                        <div class="flex items-center gap-3 bg-black/40 rounded-lg p-1">
                            <button type="button" onclick="adjustQuantity(-1)" class="w-8 h-8 rounded bg-white/10 hover:bg-white/20 flex items-center justify-center text-white">-</button>
                            <span id="order-quantity" class="w-8 text-center font-bold text-xl text-white">1</span>
                            <button type="button" onclick="adjustQuantity(1)" class="w-8 h-8 rounded bg-white/10 hover:bg-white/20 flex items-center justify-center text-white">+</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4 border-t border-white/10">
                        <span class="text-gray-300">T·ªïng thanh to√°n:</span>
                        <span id="order-total" class="text-2xl font-bold text-green-400 text-glow"></span>
                    </div>
                </div>

                <button type="submit" id="btn-submit-order" class="w-full py-4 rounded-xl font-bold text-lg text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 shadow-lg transform transition-all active:scale-95 flex items-center justify-center gap-2">
                    X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDStOsHjO0uzqvcyRhebxKzyRjJTB5EHvw",
            authDomain: "hahaha-ff408.firebaseapp.com",
            databaseURL: "https://hahaha-ff408-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hahaha-ff408",
            storageBucket: "hahaha-ff408.firebasestorage.app",
            messagingSenderId: "387922069609",
            appId: "1:387922069609:web:79e879ae7aa9f93033baf8",
            measurementId: "G-SGXLLRV07E"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // --- STATE ---
        let state = {
            products: [],
            orders: [],
            isAdmin: false,
            currentProduct: null,
            orderQuantity: 1,
            userUUID: localStorage.getItem('user_uuid') || crypto.randomUUID()
        };
        localStorage.setItem('user_uuid', state.userUUID);

        // --- BACKGROUND EFFECT ---
        const video = document.getElementById('bg-video');
        video.addEventListener('loadeddata', () => video.classList.remove('opacity-0'), { once: true });
        
        const starsContainer = document.getElementById('stars-container');
        for (let i = 0; i < 50; i++) {
            const star = document.createElement('div');
            star.className = 'absolute bg-white rounded-full opacity-0 animate-pulse';
            const size = Math.random() * 2 + 1;
            Object.assign(star.style, {
                width: `${size}px`, height: `${size}px`,
                left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`,
                animationDuration: `${Math.random() * 3 + 2}s`,
                animationDelay: `${Math.random() * 5}s`
            });
            starsContainer.appendChild(star);
        }

        // --- HELPERS ---
        const formatMoney = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        
        const uploadImageToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'A1K50_PTT');
            const res = await fetch('https://api.cloudinary.com/v1_1/dbyap7mw2/image/upload', { method: 'POST', body: formData });
            const data = await res.json();
            if (!data.secure_url) throw new Error('Upload failed');
            return data.secure_url;
        };

        // --- UI FUNCTIONS ---
        function render() {
            // Toggle Views
            const loadingView = document.getElementById('loading-view');
            const customerView = document.getElementById('customer-view');
            const adminView = document.getElementById('admin-view');
            const btnToggle = document.getElementById('btn-toggle-mode');

            loadingView.classList.add('hidden');
            
            if (state.isAdmin) {
                customerView.classList.add('hidden');
                adminView.classList.remove('hidden');
                btnToggle.innerHTML = 'üõí Xem C·ª≠a H√†ng';
                btnToggle.classList.replace('bg-black/50', 'bg-white');
                btnToggle.classList.replace('text-white', 'text-black');
                renderOrdersTable();
            } else {
                adminView.classList.add('hidden');
                customerView.classList.remove('hidden');
                btnToggle.innerHTML = 'üëë Qu·∫£n Tr·ªã';
                btnToggle.classList.replace('bg-white', 'bg-black/50');
                btnToggle.classList.replace('text-black', 'text-white');
                renderProductGrid();
            }
        }

        function renderProductGrid() {
            const container = document.getElementById('customer-view');
            if (state.products.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-gray-400">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</div>`;
                return;
            }

            container.innerHTML = state.products.map(p => {
                const rating = p.ratingCount > 0 ? (p.ratingTotal / p.ratingCount).toFixed(1) : '5.0';
                return `
                <div class="glass-panel rounded-2xl overflow-hidden group cursor-pointer hover:-translate-y-2 transition-transform duration-300 hover:shadow-[0_0_30px_rgba(168,85,247,0.3)]" onclick="window.app.openProductModal('${p.id}')">
                    <div class="aspect-square relative overflow-hidden bg-black/20">
                        <img src="${p.imageUrl}" alt="${p.name}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                        <div class="absolute top-2 right-2 bg-black/60 backdrop-blur rounded-full px-2 py-1 flex items-center gap-1 text-xs font-bold border border-white/10">
                            <span class="text-yellow-400">‚òÖ</span> ${rating}
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-1 truncate text-white">${p.name}</h3>
                        <div class="flex justify-between items-center">
                            <span class="text-green-400 font-bold text-lg">${formatMoney(p.price)}</span>
                            <button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-purple-600 transition-colors">
                                <i class="fas fa-shopping-cart text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (state.orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</td></tr>`;
                return;
            }

            tbody.innerHTML = state.orders.map(o => {
                const date = new Date(o.timestamp).toLocaleString('vi-VN');
                let statusBadge = '';
                if(o.status === 'pending') statusBadge = '<span class="px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-300 text-xs font-bold border border-yellow-500/30">ƒêang ch·ªù</span>';
                else if(o.status === 'completed') statusBadge = '<span class="px-3 py-1 rounded-full bg-green-500/20 text-green-300 text-xs font-bold border border-green-500/30">Ho√†n th√†nh</span>';
                
                return `
                <tr class="border-b border-white/5 hover:bg-white/5 transition-colors ${o.status === 'completed' ? 'opacity-50' : ''}">
                    <td class="p-4 text-sm text-gray-300">${date}</td>
                    <td class="p-4">
                        <div class="font-bold">${o.customerName}</div>
                        <div class="text-xs text-gray-400 font-mono">${o.phone}</div>
                        <div class="text-xs text-gray-400 truncate max-w-[150px]">${o.address}</div>
                    </td>
                    <td class="p-4 flex items-center gap-2">
                        <img src="${o.productImage}" class="w-8 h-8 rounded object-cover" />
                        <span class="text-sm font-medium truncate max-w-[100px]">${o.productName}</span>
                    </td>
                    <td class="p-4 font-bold text-center">x${o.quantity}</td>
                    <td class="p-4 font-bold text-green-400">${formatMoney(o.totalPrice)}</td>
                    <td class="p-4">${statusBadge}</td>
                    <td class="p-4">
                        <div class="flex justify-center gap-2">
                            ${o.status === 'pending' ? `<button onclick="window.app.updateOrder('${o.id}', 'completed')" class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white flex items-center justify-center"><i class="fas fa-check"></i></button>` : ''}
                            <button onclick="window.app.updateOrder('${o.id}', 'delete')" class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white flex items-center justify-center"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- GLOBAL EXPORTS FOR HTML EVENTS ---
        window.app = {
            openProductModal: (id) => {
                const p = state.products.find(x => x.id === id);
                if (!p) return;
                state.currentProduct = p;
                
                document.getElementById('modal-img').src = p.imageUrl;
                document.getElementById('modal-title').innerText = p.name;
                document.getElementById('modal-price').innerText = formatMoney(p.price);
                document.getElementById('modal-desc').innerText = p.description || "Kh√¥ng c√≥ m√¥ t·∫£.";
                
                const rating = p.ratingCount > 0 ? (p.ratingTotal / p.ratingCount).toFixed(1) : '5.0';
                document.getElementById('modal-rating-avg').innerText = `${rating}/5`;
                document.getElementById('modal-rating-count').innerText = `(${p.ratingCount || 0} ƒë√°nh gi√°)`;
                
                // Stars logic
                const userRated = p.ratedBy && p.ratedBy[state.userUUID];
                const starContainer = document.getElementById('modal-stars');
                starContainer.innerHTML = [1,2,3,4,5].map(s => {
                    const filled = s <= (userRated || Math.round(rating));
                    const cls = filled ? 'text-yellow-400' : 'text-gray-600';
                    const cursor = userRated ? 'cursor-default' : 'cursor-pointer hover:scale-125 transition-transform';
                    // Simple onclick for rating
                    return `<span class="${cls} ${cursor}" ${!userRated ? `onclick="window.app.rateProduct('${p.id}', ${s})"` : ''}>‚òÖ</span>`;
                }).join('');

                document.getElementById('product-modal').classList.remove('hidden');
            },
            
            rateProduct: async (id, stars) => {
                const p = state.products.find(x => x.id === id);
                if(p.ratedBy && p.ratedBy[state.userUUID]) return;
                
                const updates = {};
                updates[`products/${id}/ratingTotal`] = (p.ratingTotal || 0) + stars;
                updates[`products/${id}/ratingCount`] = (p.ratingCount || 0) + 1;
                updates[`products/${id}/ratedBy/${state.userUUID}`] = stars;
                await update(ref(database), updates);
                // Modal will update automatically via onValue listener
            },

            updateOrder: async (id, action) => {
                if(!confirm(action === 'delete' ? 'X√≥a ƒë∆°n h√†ng n√†y?' : 'X√°c nh·∫≠n ho√†n th√†nh?')) return;
                if(action === 'delete') await remove(ref(database, `orders/${id}`));
                else await update(ref(database, `orders/${id}`), { status: 'completed' });
            },

            toggleMode: () => {
                state.isAdmin = !state.isAdmin;
                render();
            }
        };

        window.closeAllModals = () => {
            document.getElementById('product-modal').classList.add('hidden');
            document.getElementById('order-modal').classList.add('hidden');
            state.currentProduct = null;
        };

        window.openOrderModal = () => {
            document.getElementById('product-modal').classList.add('hidden');
            const p = state.currentProduct;
            state.orderQuantity = 1;
            
            document.getElementById('order-img').src = p.imageUrl;
            document.getElementById('order-name').innerText = p.name;
            document.getElementById('order-unit-price').innerText = `ƒê∆°n gi√°: ${formatMoney(p.price)}`;
            updateOrderTotal();
            
            document.getElementById('order-modal').classList.remove('hidden');
        };
        window.closeOrderModal = () => document.getElementById('order-modal').classList.add('hidden');

        window.adjustQuantity = (delta) => {
            const newQ = state.orderQuantity + delta;
            if(newQ < 1) return;
            state.orderQuantity = newQ;
            document.getElementById('order-quantity').innerText = newQ;
            updateOrderTotal();
        };

        function updateOrderTotal() {
            if(!state.currentProduct) return;
            const total = state.currentProduct.price * state.orderQuantity;
            document.getElementById('order-total').innerText = formatMoney(total);
        }

        // --- EVENT LISTENERS ---
        
        // Mode Toggle
        document.getElementById('btn-toggle-mode').onclick = window.app.toggleMode;

        // Add Product
        document.getElementById('add-product-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-product');
            const fileInput = document.getElementById('product-image-input');
            const form = e.target;
            
            if(fileInput.files.length === 0) return alert('Ch∆∞a ch·ªçn ·∫£nh!');
            
            try {
                btn.disabled = true;
                btn.innerText = 'ƒêang x·ª≠ l√Ω...';
                const imageUrl = await uploadImageToCloudinary(fileInput.files[0]);
                
                await set(push(ref(database, 'products')), {
                    name: form.name.value,
                    price: parseFloat(form.price.value),
                    description: form.description.value,
                    imageUrl,
                    timestamp: Date.now(),
                    ratingTotal: 0, 
                    ratingCount: 0
                });
                
                form.reset();
                alert('ƒêƒÉng b√°n th√†nh c√¥ng!');
            } catch(err) {
                alert('L·ªói: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'ƒêƒÇNG B√ÅN NGAY';
            }
        };

        // Submit Order
        document.getElementById('order-form').onsubmit = async (e) => {
            e.preventDefault();
            const p = state.currentProduct;
            if(!p) return;
            
            const btn = document.getElementById('btn-submit-order');
            try {
                btn.disabled = true;
                btn.innerText = 'ƒêang g·ª≠i ƒë∆°n...';
                
                const formData = new FormData(e.target);
                await set(push(ref(database, 'orders')), {
                    productId: p.id,
                    productName: p.name,
                    productImage: p.imageUrl,
                    unitPrice: p.price,
                    quantity: state.orderQuantity,
                    totalPrice: p.price * state.orderQuantity,
                    customerName: formData.get('customerName'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    status: 'pending',
                    timestamp: Date.now()
                });
                
                window.closeOrderModal();
                alert('ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm.');
            } catch(err) {
                alert('L·ªói: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG';
            }
        };

        // --- DATA SYNC ---
        onValue(ref(database, 'products'), (snap) => {
            const data = snap.val();
            state.products = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })).reverse() : [];
            render();
            
            // Live update modal if open
            if(state.currentProduct) {
                const updated = state.products.find(p => p.id === state.currentProduct.id);
                if(updated) {
                    state.currentProduct = updated;
                    // Re-render modal only rating part ideally, but full re-open works for now
                    // To avoid closing/flickering, we just update data quietly unless UI needs heavy change
                }
            }
        });

        onValue(ref(database, 'orders'), (snap) => {
            const data = snap.val();
            state.orders = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })).reverse() : [];
            if(state.isAdmin) renderOrdersTable();
        });

    </script>
</body>
</html>